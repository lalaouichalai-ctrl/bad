<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mes Cartes Bancaires</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        /* Custom styles for the stylized card number */
        .card-number { font-family: 'Courier New', monospace; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center space-y-3 md:space-y-0">
                
                <!-- Logo and User Info -->
                <div class="flex items-center space-x-4">
                    <img src="https://nextbillion.net/wp-content/uploads/1024px-Logo_Afrikanische_Entwicklungsbank.svg.png" class="h-12 w-auto" alt="Logo Ecobank">
                    <div class="text-sm">
                        <span class="font-semibold text-gray-700">Bienvenue Monsieur / Madame</span>
                        <p id="last-conn" class="text-xs text-gray-500">Dernière connexion...</p>
                        <button id="logout-button" class="text-xs text-red-600 hover:text-red-800 transition duration-150"></button>
                    </div>
                </div>

                <!-- Account and Advisor Info -->
                <div class="flex items-center space-x-6 text-right">
                    <div class="flex flex-col">
                        <span id="client-solde" class="text-2xl font-bold text-green-700">0,00 €</span>
                        <span class="text-xs text-gray-500">Solde Compte Courant</span>
                    </div>
                    <div class="hidden sm:block border-l pl-6">
                        <p class="text-sm text-gray-700">Votre conseiller</p>
                        <strong id="advisor-name" class="text-sm text-blue-600">Chargement...</strong>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-blue-800 shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-12">
                <ul class="flex space-x-4 text-sm font-medium">
                    <li><a href="dashboard.html" class="text-white hover:bg-blue-700 px-3 py-2 rounded-md transition duration-150">VOS COMPTES</a></li>
                    <li><a href="historique.html" class="text-white hover:bg-blue-700 px-3 py-2 rounded-md transition duration-150">OPERATIONS</a></li>
                    <li><a href="#" class="text-white bg-blue-700 px-3 py-2 rounded-md">CARTES</a></li>
                </ul>
                <input type="search" placeholder="Rechercher..." class="px-3 py-1 text-sm rounded-full border border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 w-32 md:w-48">
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 flex-grow flex flex-col lg:flex-row gap-6">
        
        <!-- Main Content Area -->
        <main class="lg:w-3/4 w-full bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Mes Cartes Bancaires</h2>

            <div class="flex justify-center mb-8">
                <!-- Bank Card Display -->
                <div id="bank-card" class="w-80 h-48 sm:w-96 sm:h-56 bg-gradient-to-br from-blue-900 to-blue-600 text-white rounded-2xl p-6 shadow-2xl shadow-blue-900/50 relative transform hover:scale-[1.02] transition duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <svg viewBox="0 0 32 32" fill="none" class="w-12 h-12 text-yellow-400" xmlns="http://www.w3.org/2000/svg">
                            <rect width="32" height="32" rx="6" fill="currentColor"/>
                            <circle cx="10" cy="16" r="6" fill="white"/>
                            <circle cx="22" cy="16" r="6" fill="yellow" opacity="0.8"/>
                        </svg>
                        <div id="card-type" class="text-xl font-bold uppercase tracking-wider">VISA</div>
                    </div>
                    <div id="card-number" class="text-2xl sm:text-3xl tracking-widest my-6 card-number">
                        XXXX XXXX XXXX XXXX
                    </div>
                    <div class="flex justify-between text-sm sm:text-base">
                        <div id="card-holder-name" class="font-semibold uppercase truncate max-w-[60%]">NOM DU TITULAIRE</div>
                        <div class="text-xs sm:text-sm">Valide jusqu'à: <span id="expiry-date" class="font-bold">MM/AA</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Card Actions and Status -->
            <div id="status-card-box" class="mt-8 p-4 rounded-xl border border-gray-200">
                <h4 class="text-lg font-semibold text-gray-700 mb-3">Statut du Compte et de la Carte</h4>
                
                <div id="account-status-display" class="inline-block px-4 py-2 rounded-full font-bold text-sm bg-green-100 text-green-700 transition duration-300">
                    Chargement du statut...
                </div>
                
                <p id="lock-reason-display" class="text-sm mt-3 p-2 bg-red-100 text-red-700 border-l-4 border-red-500 hidden"></p>

                <div class="mt-6 flex flex-wrap gap-4 justify-center sm:justify-start">
                    <button class="flex items-center justify-center space-x-2 px-4 py-2 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600 transition duration-150 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.707 4.293a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-5-5a1 1 0 011.414-1.414L10 8.586l4.293-4.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Augmenter Plafond
                    </button>
                    <button class="flex items-center justify-center space-x-2 px-4 py-2 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 transition duration-150 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v4a1 1 0 102 0V7z" clip-rule="evenodd" /></svg>
                        Contacter SAV
                    </button>
                    <button class="flex items-center justify-center space-x-2 px-4 py-2 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 12a2 2 0 00-2 2v2a2 2 0 002 2h12a2 2 0 002-2v-2a2 2 0 00-2-2H4zm16-4h-4v-.5a3.5 3.5 0 00-7 0V8H4a2 2 0 00-2 2v2h16V10a2 2 0 00-2-2zM9 8v-.5a1.5 1.5 0 013 0V8H9z"/></svg>
                        Faire opposition
                    </button>
                </div>
            </div>

        </main>
        
        <!-- Right Panel (Aside) -->
        <aside class="lg:w-1/4 w-full p-4 lg:p-0">
            <div class="bg-white p-4 rounded-xl shadow-lg space-y-3">
                <h3 class="font-semibold text-lg text-gray-800 mb-2">Accès Rapide</h3>
                <a href="dashboard.html" class="block w-full">
                    <button class="w-full bg-blue-100 text-blue-800 hover:bg-blue-200 py-2 rounded-lg font-medium transition duration-150">Synthèse des comptes</button>
                </a>
                <a href="#" class="block w-full">
                    <button class="w-full bg-blue-100 text-blue-800 hover:bg-blue-200 py-2 rounded-lg font-medium transition duration-150">Faire un virement</button>
                </a>
                <a href="profil.html" class="block w-full">
                    <button class="w-full bg-blue-100 text-blue-800 hover:bg-blue-200 py-2 rounded-lg font-medium transition duration-150">Mon Profil</button>
                </a>
                <a href="historique.html" class="block w-full">
                    <button class="w-full bg-blue-100 text-blue-800 hover:bg-blue-200 py-2 rounded-lg font-medium transition duration-150">Historique</button>
                </a>
                <button class="w-full bg-gray-200 text-gray-700 hover:bg-gray-300 py-2 rounded-lg font-medium transition duration-150">Espace SAV</button>
            </div>
        </aside>

    </div>

    <!-- Footer -->
   <footer>
  <p>© BANQUE AFRICAINE DE DEVELOPPEMENT</p>
</footer>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables are provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Set log level for debugging
        setLogLevel('debug');

        /**
         * Utility function to format a number as a Euro currency string.
         * @param {number} amount
         * @returns {string}
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
            }).format(amount);
        }

        /**
         * Populates the UI with the fetched user profile data.
         * @param {object} userData
         */
        function updateUI(userData) {
            if (!userData) {
                console.warn("No user data available to update UI.");
                return;
            }

            const statusDisplay = document.getElementById('account-status-display');
            const reasonDisplay = document.getElementById('lock-reason-display');
            const bankCard = document.getElementById('bank-card');
            
            // 1. Header Info
            document.getElementById('client-solde').textContent = formatCurrency(userData.solde || 0);
            document.getElementById('advisor-name').textContent = userData.advisor || 'N/A';
            document.getElementById('last-conn').textContent = `Dernière connexion le ${userData.lastConnection || 'N/A'}`;

            // 2. Card Details
            const cardData = {
                number: userData.cardNumber,
                holderName: userData.cardHolderName || userData.name,
                expiry: userData.expiryDate,
                type: userData.cardType,
            };

            if (cardData.number) {
                const formattedNumber = cardData.number.match(/.{1,4}/g).join(' ');
                document.getElementById('card-number').textContent = formattedNumber;
                document.getElementById('card-holder-name').textContent = cardData.holderName.toUpperCase();
                document.getElementById('expiry-date').textContent = cardData.expiry || 'MM/AA';
                document.getElementById('card-type').textContent = cardData.type || 'VISA';
                bankCard.classList.remove('p-8');
            } else {
                bankCard.innerHTML = '<div class="p-8 text-center text-white/80">Aucune carte enregistrée pour cet utilisateur.</div>';
            }

            // 3. Status Display
            if (userData.isLocked) {
                statusDisplay.classList.remove('bg-green-100', 'text-green-700');
                statusDisplay.classList.add('bg-red-100', 'text-red-700', 'border-red-500');
                statusDisplay.innerHTML = 'Votre compte est <strong>BLOQUÉ</strong> !';
                if (userData.lockReason) {
                    reasonDisplay.textContent = `Raison: ${userData.lockReason}`;
                    reasonDisplay.classList.remove('hidden');
                }
            } else {
                statusDisplay.classList.remove('bg-red-100', 'text-red-700', 'border-red-500');
                statusDisplay.classList.add('bg-green-100', 'text-green-700');
                statusDisplay.innerHTML = 'Votre compte est <strong>ACTIF</strong>.';
                reasonDisplay.classList.add('hidden');
            }
        }

        /**
         * Fetches and listens for real-time user profile data from Firestore.
         * @param {string} userId
         */
        function startDataListener(userId) {
            const profileRef = doc(db, 'artifacts', appId, 'users', userId, 'banking', 'profile');
            
            // Set up a snapshot listener for real-time updates
            onSnapshot(profileRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    console.log("Current data:", userData);
                    updateUI(userData);
                } else {
                    console.log("No profile found for user. Creating a default profile.");
                    
                    // Create a default profile if none exists
                    const defaultProfile = {
                        name: "Client Standard",
                        solde: 1500.00,
                        advisor: "Non Assigné",
                        lastConnection: new Date().toLocaleDateString('fr-FR'),
                        cardNumber: "4000123456789010",
                        cardHolderName: "C. STANDARD",
                        expiryDate: "12/28",
                        cardType: "VISA CLASSIC",
                        isLocked: false,
                        lockReason: "",
                    };

                    await setDoc(profileRef, defaultProfile)
                        .then(() => console.log("Default profile created."))
                        .catch(e => console.error("Error creating default profile: ", e));
                    
                    updateUI(defaultProfile);
                }
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                document.getElementById('account-status-display').textContent = 'Erreur de connexion aux données.';
            });
        }


        // Main execution logic
        document.addEventListener('DOMContentLoaded', async () => {
            let userId = null;

            try {
                // 1. Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // 2. Get the authenticated user ID
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("User ID:", userId);

                // 3. Start listening for data
                if (userId) {
                    startDataListener(userId);
                }
                
            } catch (error) {
                console.error("Authentication or initialization failed:", error);
            }

            // 4. Set up Logout Handler
            document.getElementById('logout-button').addEventListener('click', (e) => {
                e.preventDefault();
                // In a real app, this would sign out the user.
                // For this environment, we just log a message.
                console.log("User logged out (simulated).");
                alert("Déconnexion simulée. L'application est prête à être exécutée.");
            });
        });
    </script>
</body>
</html>